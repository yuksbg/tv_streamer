variables:
  IMG: "registry.yuks.me/school_admin_tv:latest"

stages:
  - tag
  - build
#  - deploy

auto_tag:
  stage: tag
  image: bash:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      set -e
      git config --global user.email "ci-bot@example.com"
      git config --global user.name "CI Bot"
      git fetch --tags

      # Get today's date
      TODAY=$(date +%Y-%m-%d)

      # Find latest tag matching vX.Y.Z
      LATEST_TAG=$(git tag --list "v*.*.*" --sort=-v:refname | head -n1)
      if [ -z "$LATEST_TAG" ]; then
        NEW_TAG="v1.0.0"
      else
        # Extract numbers
        VERSION_REGEX="^v([0-9]+)\.([0-9]+)\.([0-9]+)$"
        if [[ $LATEST_TAG =~ $VERSION_REGEX ]]; then
          X="${BASH_REMATCH[1]}"
          Y="${BASH_REMATCH[2]}"
          Z="${BASH_REMATCH[3]}"
        else
          X=1; Y=0; Z=0
        fi

        # Get date of latest tag commit
        TAG_COMMIT=$(git rev-list -n 1 "$LATEST_TAG")
        TAG_DATE=$(git show -s --format=%ci "$TAG_COMMIT" | cut -d" " -f1)

        if [ "$TAG_DATE" = "$TODAY" ]; then
          # Same day, increment Z
          Z=$((Z+1))
        else
          # New day, increment Y, reset Z
          Y=$((Y+1))
          Z=0
        fi
        NEW_TAG="v${X}.${Y}.${Z}"
      fi

      echo "Latest tag: $LATEST_TAG"
      echo "New tag: $NEW_TAG"

      # Create and push new tag
      git tag "$NEW_TAG"
      git push https://gitlab-ci-token:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git "$NEW_TAG"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: on_success


build:
  stage: build
  image:
    name: moby/buildkit:rootless
    entrypoint: [ "" ]
  variables:
    BUILDKITD_FLAGS: --oci-worker-no-process-sandbox
  script:
    - |
      mkdir -p ~/.docker/
      echo "{\"auths\":{\"registry.yuks.me\":{\"username\":\"yuks\",\"password\":\"yuksel1\"}}}" > ~/.docker/config.json
      buildctl-daemonless.sh build \
      --frontend=dockerfile.v0 \
      --local context=. \
      --local dockerfile=. \
      --opt build-arg:GITLAB_TOKEN="$GITLAB_TOKEN" \
      --opt build-arg:VersionTag="${CI_COMMIT_TAG:-manual}" \
      --output type=image,name="$IMG",push=true
  rules:
    # Run automatically on version tags (e.g., v1.0.0)
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
      when: on_success
    # Allow manual trigger from GitLab UI at any time
    - when: manual
      allow_failure: true

#deploy_prod:
#  image: alpine:3.17
#  variables:
#    GIT_STRATEGY: none
#  stage: deploy
#  needs: [build]
#  script:
#    # Update the package list and install required packages
#    - apk update && apk add openssh-client
#    # Set up SSH configuration
#    - mkdir -p ~/.ssh
#    - chmod 700 ~/.ssh
#    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
#    - eval $(ssh-agent -s)
#    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#    # Deploy the latest Docker image
#    - ssh root@optimus.yuks.me "docker pull $IMG && cd /opt/projects/slaveykov && docker compose up -d"
#    # Create and execute the cleanup script on the remote server
#    - |
#      ssh root@optimus.yuks.me << 'EOF'
#      instances=$(docker images | grep 'registry.yuks.me/school_admin_cms' | grep none | awk '{print $3}')
#      echo "The following Docker image instances will be removed:"
#      echo "$instances"
#      docker rmi $instances || true
#      EOF
#  rules:
#    # Run automatically on version tags (e.g., v1.0.0)
#    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'
#      when: on_success
#    # Allow manual trigger from GitLab UI at any time
#    - when: manual
#      allow_failure: true