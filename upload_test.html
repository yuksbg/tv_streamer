<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket File Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 8px;
        }
        h1 {
            color: #333;
        }
        .upload-section {
            margin: 20px 0;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        button:hover:not(:disabled) {
            background-color: #45a049;
        }
        .log-section {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4CAF50;
            background-color: white;
        }
        .log-entry.error {
            border-left-color: #f44336;
        }
        .log-entry.info {
            border-left-color: #2196F3;
        }
        .progress {
            width: 100%;
            height: 30px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Chunked File Upload Test</h1>

        <div class="upload-section">
            <h3>Select Video File</h3>
            <input type="file" id="fileInput" accept="video/*">
            <br>
            <button id="uploadBtn" onclick="startUpload()">Upload File</button>
            <button id="connectBtn" onclick="connect()">Connect WebSocket</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
        </div>

        <div>
            <h3>Upload Progress</h3>
            <div class="progress">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <div class="log-section">
            <h3>Logs</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let uploadSession = null;
        const CHUNK_SIZE = 256 * 1024; // 256KB chunks (matches server config)

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent.toFixed(1) + '%';
        }

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket already connected', 'info');
                return;
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.hostname}:8080/api/ws`;

            log(`Connecting to ${wsUrl}...`, 'info');
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                log('WebSocket connected successfully', 'info');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('uploadBtn').disabled = false;
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleServerMessage(data);
                } catch (e) {
                    log('Received non-JSON message: ' + event.data, 'info');
                }
            };

            ws.onerror = (error) => {
                log('WebSocket error occurred', 'error');
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                log('WebSocket connection closed', 'info');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('uploadBtn').disabled = true;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function handleServerMessage(data) {
            log(`Server: ${data.type}`, 'info');

            switch (data.type) {
                case 'connection':
                    log(data.message, 'info');
                    break;

                case 'upload_init_success':
                    log(`Upload initialized. Session ID: ${data.session_id}`, 'info');
                    uploadSession.sessionId = data.session_id;
                    sendChunks();
                    break;

                case 'upload_chunk_ack':
                    log(`Chunk ${uploadSession.currentChunk} acknowledged`, 'info');
                    uploadSession.currentChunk++;
                    sendChunks();
                    break;

                case 'upload_complete':
                    log(`Upload completed! File ID: ${data.file_id}`, 'info');
                    log(data.message, 'info');
                    uploadSession = null;
                    updateProgress(100);
                    break;

                case 'upload_error':
                    log(`Upload error: ${data.error}`, 'error');
                    uploadSession = null;
                    updateProgress(0);
                    break;

                default:
                    console.log('Received message:', data);
            }
        }

        function startUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                log('Please select a file first', 'error');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket is not connected. Please connect first.', 'error');
                return;
            }

            log(`Starting upload of: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');

            uploadSession = {
                file: file,
                totalChunks: Math.ceil(file.size / CHUNK_SIZE),
                currentChunk: 0,
                sessionId: null
            };

            // Send upload initialization message
            const initMessage = {
                type: 'upload_init',
                filename: file.name,
                file_size: file.size
            };

            ws.send(JSON.stringify(initMessage));
            log('Sent upload initialization request', 'info');
        }

        function sendChunks() {
            if (!uploadSession) return;

            const { file, totalChunks, currentChunk, sessionId } = uploadSession;

            if (currentChunk >= totalChunks) {
                // All chunks sent, send completion message
                log('All chunks sent, completing upload...', 'info');
                ws.send(JSON.stringify({
                    type: 'upload_complete',
                    session_id: sessionId
                }));
                return;
            }

            const start = currentChunk * CHUNK_SIZE;
            const end = Math.min(start + CHUNK_SIZE, file.size);
            const chunk = file.slice(start, end);

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64Data = btoa(
                    new Uint8Array(e.target.result)
                        .reduce((data, byte) => data + String.fromCharCode(byte), '')
                );

                const chunkMessage = {
                    type: 'upload_chunk',
                    session_id: sessionId,
                    chunk_data: base64Data,
                    chunk_num: currentChunk
                };

                ws.send(JSON.stringify(chunkMessage));

                const progress = ((currentChunk + 1) / totalChunks) * 100;
                updateProgress(progress);
                log(`Sent chunk ${currentChunk + 1}/${totalChunks}`, 'info');
            };

            reader.readAsArrayBuffer(chunk);
        }

        // Auto-connect on page load
        window.onload = () => {
            document.getElementById('uploadBtn').disabled = true;
            log('Page loaded. Click "Connect WebSocket" to start.', 'info');
        };
    </script>
</body>
</html>
